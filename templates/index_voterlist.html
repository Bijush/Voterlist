<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Voter Lists</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root{
      --brand-green: #1b5e20;
      --accent-green: #2e7d32;
      --muted: #6c757d;
      --surface: #ffffff;
      --bg: #f4f6f8;
    }

    html,body{height:100%}
    body {
      margin:0;
      background: var(--bg);
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      padding-bottom: 110px; /* room for fixed footer & UI */
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      color:#222;
    }

    /* NAV */
    .navbar {
      background-color: var(--brand-green);
      padding: 10px 0;
      box-shadow: 0 2px 8px rgba(6,24,49,0.06);
    }
    .navbar-brand { color:#fff !important; font-weight:700; font-size:1.15rem; }
    .upload-icon { background: rgba(255,255,255,0.06); border-radius: 999px; padding:8px 12px; color:#fff; display:inline-flex; align-items:center; gap:8px; text-decoration:none; border:1px solid rgba(255,255,255,0.06) }
    .upload-icon:hover { background: rgba(255,255,255,0.12); text-decoration:none; }

    .container-top { margin-top:14px; }

    /* Filter Panel - visible on desktop, collapsed on mobile */
    .filter-panel { display:block; }
    @media (max-width: 767px){ .filter-panel{ display:none; } }
    .filter-card {
      background: var(--surface);
      border-radius: 12px;
      padding:12px;
      box-shadow: 0 4px 14px rgba(6,24,49,0.04);
      border: 1px solid rgba(6,24,49,0.04);
    }
    .filter-select { border-radius:10px; min-height:44px; }

    /* Card - premium material style */
    .entry-card .card-surface {
      background: var(--surface);
      border-radius: 14px;
      overflow: hidden;
      transition: transform .18s ease, box-shadow .18s ease;
      border: 1px solid rgba(6,24,49,0.04);
      box-shadow: 0 6px 20px rgba(6,24,49,0.06);
    }
    .entry-card .card-surface:hover {
      transform: translateY(-6px);
      box-shadow: 0 14px 40px rgba(6,24,49,0.09);
    }
    .card-body-compact { padding:18px; }

    /* LAC / Year */
    .lac-title { color: #0f5132; font-weight:800; font-size:1rem; margin-bottom:6px; }
    .year-big { color: var(--accent-green); font-size:1.25rem; font-weight:700; line-height:1; }

    /* booth/school */
    .booth { color: #444; font-weight:600; margin-top:6px; margin-bottom:8px; }
    .address { color: var(--muted); font-size:0.95rem; margin-bottom:10px; white-space:normal; }

    /* file name box */
    .file-box {
      background:#f3f4f6;
      border-radius:8px;
      padding:10px;
      font-weight:600;
      color:#111;
      display:inline-block;
      margin-top:6px;
    }

    /* uploaded time */
    .uploaded {
      font-size:0.85rem;
      color:var(--muted);
    }

    /* action buttons row */
    .card-actions { padding:12px; border-top: 1px solid rgba(6,24,49,0.03); background: linear-gradient(180deg, rgba(255,255,255,0.0), rgba(255,255,255,0.02)); display:flex; justify-content:flex-end; gap:8px; }
    .btn-action { min-width:44px; height:38px; border-radius:10px; display:inline-flex; align-items:center; justify-content:center; padding:0 8px; }

    /* footer */
    footer.site-footer {
      background: #ffffff;
      border-top:1px solid #e9ecef;
      padding: 12px 0;
      position: fixed;
      left:0; right:0; bottom:0;
      text-align:center;
      font-size:14px;
      color:#444;
      z-index:1200;
    }

    /* scroll to top */
    #toTopBtn{ position: fixed; right:16px; bottom:86px; display:none; z-index:1200; box-shadow:0 8px 24px rgba(6,24,49,0.12); }

    /* responsive tweaks */
    @media (max-width:575px){
      .card-body-compact{ padding:14px; }
      .file-box{ display:block; width:100%; }
    }
  </style>
</head>
<body>

  <!-- NAV -->
  <nav class="navbar navbar-expand-lg">
    <div class="container">
      <a class="navbar-brand" href="#">ðŸ“‹ Voter Lists</a>

      <div class="ms-auto d-flex align-items-center gap-2">
        <a href="{{ url_for('upload') }}" class="upload-icon" title="Upload">
          <i class="bi bi-cloud-upload" style="font-size:1.05rem;"></i>
          <span class="d-none d-md-inline" style="font-weight:600;">Upload</span>
        </a>
      </div>
    </div>
  </nav>

  <div class="container container-top">

    <!-- MOBILE: Show Filters Button -->
    <div class="d-md-none mb-3">
      <button id="toggleFilters" class="btn btn-primary w-100">Show Filters â†“</button>
    </div>

    <!-- FILTERS (desktop visible / mobile toggled) -->
    <div id="filterPanel" class="filter-panel mb-3">
      <div class="filter-card">
        <div class="row g-2 align-items-center">

          <!-- LAC (JS-populated optgroups) -->
          <div class="col-12 col-md-3">
            <label class="form-label">LAC</label>
            <select id="lacFilter" class="form-select filter-select">
              <option value="">All LACs</option>
            </select>
          </div>

          <!-- District -->
          <div class="col-6 col-md-2">
            <label class="form-label">District</label>
            <select id="districtFilter" class="form-select filter-select">
              <option value="">All Districts</option>
              {% for d in entries|unique(attribute='district')|sort(attribute='district') %}
              <option>{{ d.district }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Block -->
          <div class="col-6 col-md-2">
            <label class="form-label">Block</label>
            <select id="blockFilter" class="form-select filter-select">
              <option value="">All Blocks</option>
              {% for b in entries|unique(attribute='block')|sort(attribute='block') %}
              <option>{{ b.block }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- GP -->
          <div class="col-6 col-md-2">
            <label class="form-label">GP</label>
            <select id="gpFilter" class="form-select filter-select">
              <option value="">All GPs</option>
              {% for g in entries|unique(attribute='gp')|sort(attribute='gp') %}
              <option>{{ g.gp }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Polling -->
          <div class="col-6 col-md-2">
            <label class="form-label">Polling</label>
            <select id="pollingFilter" class="form-select filter-select">
              <option value="">All Polling</option>
              {% for p in entries|unique(attribute='polling_station')|sort(attribute='polling_station') %}
              <option>{{ p.polling_station }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Year (sorted ascending) -->
          <div class="col-6 col-md-1">
            <label class="form-label">Year</label>
            <select id="yearFilter" class="form-select filter-select">
              <option value="">All Years</option>
              {% for y in entries|unique(attribute='year')|sort(attribute='year') %}
              <option>{{ y.year }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Search -->
          <div class="col-12 col-md-4">
            <label class="form-label">Search</label>
            <input id="searchBox" type="search" class="form-control filter-select" placeholder="Search name/file...">
          </div>
        </div>
      </div>
    </div>

    <!-- ENTRIES -->
    <div id="entriesList" class="row g-3">
      {% for e in entries %}
      <div class="col-12 col-md-6 col-lg-4 entry-card"
           data-lac="{{ e.lac_no }}"
           data-district="{{ e.district }}"
           data-block="{{ e.block }}"
           data-gp="{{ e.gp }}"
           data-polling="{{ e.polling_station }}"
           data-year="{{ e.year }}"
           data-name="{{ e.filename|lower }}">
        <div class="card-surface">
          <div class="card-body card-body-compact">
            <div class="d-flex justify-content-between">
              <div>
                <div class="lac-title">LAC: {{ e.lac_no }}</div>
                <div class="year-big">{{ e.year or "â€”" }}</div>
                <div class="booth">{{ e.polling_station }}</div>
                <div class="address">{{ e.district }} / {{ e.block }} / {{ e.gp }}</div>
              </div>
              <div class="text-end">
                <div class="uploaded">Uploaded</div>
                <div class="uploaded" style="font-weight:600;">{{ e.uploaded_at }}</div>
              </div>
            </div>

            <div class="mt-3">
              <div class="file-box">File: {{ e.filename }}</div>
            </div>
          </div>

          <div class="card-actions">
            <div class="d-flex gap-2">
              {% if e.public_url %}
              <a class="btn btn-outline-primary btn-action" href="{{ e.public_url }}" target="_blank" title="View">
                <i class="bi bi-eye"></i>
              </a>
              {% endif %}
              <a class="btn btn-outline-success btn-action" href="{{ url_for('download_entry', entry_id=e.id) }}" title="Download">
                <i class="bi bi-download"></i>
              </a>

              <!-- Delete permanently commented out -->
              <!--
              <form action="{{ url_for('delete_entry', entry_id=e.id) }}" method="post" onsubmit="return confirm('Delete?');">
                <button class="btn btn-outline-danger btn-action" type="submit"><i class="bi bi-trash"></i></button>
              </form>
              -->
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <div class="text-center text-muted mt-3">Tip: Use filters or search above.</div>
  </div>

  <!-- scroll to top -->
  <button id="toTopBtn" class="btn btn-success rounded-circle" title="Back to top" aria-label="Back to top">
    <i class="bi bi-arrow-up"></i>
  </button>

  <!-- footer -->
  <footer class="site-footer">
    <div><strong>Â© 2025 Bijush Kumar Roy</strong></div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Hardcoded LAC groups (server-side can replace this if desired)
    const lacGroups = {
      "Cachar": ["42-Udharbond", "117-Borkhola"],
      "Karimganj": ["3-Ratabari", "4-Patharkandi"],
      "Hailakandi": ["6-Hailakandi", "7-Katlicherra"]
    };

    // Sort LACs numerically then name
    function sortLacArray(arr) {
      return arr.slice().sort((a,b)=>{
        const na = Number(a.split('-',1)[0]);
        const nb = Number(b.split('-',1)[0]);
        if (!isNaN(na) && !isNaN(nb) && na !== nb) return na - nb;
        return a.localeCompare(b);
      });
    }

    function populateLacDropdown() {
      const sel = document.getElementById('lacFilter');
      while (sel.options.length > 1) sel.remove(1);

      Object.keys(lacGroups).sort().forEach(d => {
        const og = document.createElement('optgroup');
        og.label = d;
        sortLacArray(lacGroups[d]).forEach(lac => {
          const o = document.createElement('option');
          o.value = lac;
          o.text = lac;
          og.appendChild(o);
        });
        sel.appendChild(og);
      });
    }

    // Filtering logic
    function filterEntries(){
      const lac = (document.getElementById('lacFilter')?.value || '').toLowerCase();
      const district = (document.getElementById('districtFilter')?.value || '').toLowerCase();
      const block = (document.getElementById('blockFilter')?.value || '').toLowerCase();
      const gp = (document.getElementById('gpFilter')?.value || '').toLowerCase();
      const polling = (document.getElementById('pollingFilter')?.value || '').toLowerCase();
      const year = (document.getElementById('yearFilter')?.value || '').toLowerCase();
      const search = (document.getElementById('searchBox')?.value || '').toLowerCase();

      document.querySelectorAll('.entry-card').forEach(card=>{
        const cLac = (card.dataset.lac || '').toLowerCase();
        const cDistrict = (card.dataset.district || '').toLowerCase();
        const cBlock = (card.dataset.block || '').toLowerCase();
        const cGp = (card.dataset.gp || '').toLowerCase();
        const cPolling = (card.dataset.polling || '').toLowerCase();
        const cYear = (card.dataset.year || '').toLowerCase();
        const cName = (card.dataset.name || '').toLowerCase();

        const ok =
          (!lac || cLac === lac) &&
          (!district || cDistrict === district) &&
          (!block || cBlock === block) &&
          (!gp || cGp === gp) &&
          (!polling || cPolling === polling) &&
          (!year || cYear === year) &&
          (!search || cName.includes(search));

        card.style.display = ok ? '' : 'none';
      });
    }

    // Scroll to top button logic
    const toTopBtn = document.getElementById('toTopBtn');
    window.addEventListener('scroll', ()=>{
      if (window.scrollY > 300) toTopBtn.style.display = 'inline-block';
      else toTopBtn.style.display = 'none';
    });
    toTopBtn.addEventListener('click', ()=> window.scrollTo({top:0, behavior:'smooth'}));

    // Toggle filter panel on mobile
    document.addEventListener('DOMContentLoaded', ()=>{
      populateLacDropdown();

      // Add listeners
      ['lacFilter','districtFilter','blockFilter','gpFilter','pollingFilter','yearFilter','searchBox'].forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', filterEntries);
      });

      // Also make selects react on 'change'
      ['lacFilter','districtFilter','blockFilter','gpFilter','pollingFilter','yearFilter'].forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.addEventListener('change', filterEntries);
      });

      // Add missing LACs found in entries (optional)
      const present = new Set(Array.from(document.querySelectorAll('.entry-card')).map(c=>c.dataset.lac).filter(Boolean));
      const sel = document.getElementById('lacFilter');
      present.forEach(lac=>{
        if (![...sel.options].some(o=>o.value===lac)){
          const o = document.createElement('option'); o.value=lac; o.text=lac; sel.appendChild(o);
        }
      });

      filterEntries();

      const toggleBtn = document.getElementById('toggleFilters');
      const panel = document.getElementById('filterPanel');
      if (toggleBtn){
  toggleBtn.addEventListener('click', ()=>{
    const isVisible = window.getComputedStyle(panel).display !== "none";

    if (isVisible) {
      panel.style.display = 'none';
      toggleBtn.textContent = 'Show Filters â†“';
      toggleBtn.classList.remove('btn-outline-secondary');
      toggleBtn.classList.add('btn-primary');
    } else {
      panel.style.display = 'block';
      toggleBtn.textContent = 'Hide Filters â†‘';
      toggleBtn.classList.remove('btn-primary');
      toggleBtn.classList.add('btn-outline-secondary');
    }
  });
}
    });
  </script>
</body>
</html>
